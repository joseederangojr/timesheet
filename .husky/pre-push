# Step 1: Install/update dependencies first (this may modify lockfiles)
npm install && composer update --lock

# Step 2: Stage ONLY the updated lockfiles (if they changed)
git add -u -- package-lock.json composer.lock

# Step 3: Format and lint (JS + PHP) - these modify files in place
npm run format && npm run lint && npm run format:php && vendor/bin/pint -p

# Step 4: Type check and build (JS)
npm run test:types && npm run build

# Step 5: PHP refactoring and static analysis (may modify files)
vendor/bin/rector process && vendor/bin/phpstan --memory-limit=2G

# Step 6: Identify files that were already staged in the previous commit
#     (these are the "originally committed" files; ignore lockfiles since we handle them separately)
git diff --cached --name-only --diff-filter=d | grep -v -E '^(package-lock\.json|composer\.lock)$' > /tmp/original_files.txt

# Step 7: Find modified files (from formatting/refactoring) that match the original list
git diff --name-only | grep -f /tmp/original_files.txt > /tmp/matching_modified.txt || true

# Step 8: Stage ONLY those matching modified files (replaces previous versions in the commit)
if [ -s /tmp/matching_modified.txt ]; then
  xargs git add < /tmp/matching_modified.txt
fi

# Step 9: Clean up temp files
rm -f /tmp/original_files.txt /tmp/matching_modified.txt

# Step 10: Amend the previous commit (includes updated lockfiles + modified originals)
git commit --amend --no-edit
